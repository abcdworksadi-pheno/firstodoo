# name: Deploy Odoo

# on:
#   push:
#     branches: ["main"]

# jobs:
#   deploy:
#     runs-on: self-hosted

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Copier les fichiers sur le serveur
#         run: |
#           rsync -avz --delete ./ $HOME/firstodoo/

#       - name: Red√©ployer Odoo
#         run: |
#           cd $HOME/firstodoo
#           docker-compose down
#           docker-compose up -d --build
name: CI/CD Odoo

on:
  push:
    branches: ["main"]

jobs:
  test:
    name: Test Odoo Modules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Python deps
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip
          pip3 install pylint

      - name: Lint Odoo modules
        run: |
          pylint ./addons/* || true

      - name: Clean old test containers
        run: |
          docker compose -f docker-compose.test.yml down -v || true

      - name: Run Odoo tests
        run: |
          docker compose -f docker-compose.test.yml up --abort-on-container-exit --exit-code-from odoo
        continue-on-error: false

  deploy:
    name: Deploy to Server
    needs: test
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Sync files to server
        run: |
          rsync -avz --delete \
            ./ \
            $HOME/firstodoo/

      - name: Rebuild Odoo with retry
        run: |
          cd $HOME/firstodoo

          echo "Stopping old containers..."
          docker compose down || true

          echo "Building new containers..."
          for i in {1..5}; do
            docker compose up -d --build && break
            echo "Retrying build ($i/5)..."
            sleep 3
          done

      - name: Install new module
        run: |
          docker exec odoo18-odoo \
            odoo -c /etc/odoo/odoo.conf \
            -d odoo18 \
            -u ALL \
            --stop-after-init

      - name: Check Odoo health
        run: |
          curl -f http://localhost:8069 || exit 1
