# name: CI/CD Odoo

# on:
#   push:
#     branches: ["main"]

# jobs:
#   test:
#     name: Test Odoo Modules
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Install Python deps
#         run: |
#           sudo apt update
#           sudo apt install -y python3 python3-pip
#           pip3 install pylint

#       - name: Lint Odoo modules
#         run: |
#           pylint ./addons/* || true

#       - name: Clean old test containers
#         run: |
#           docker compose -f docker-compose.test.yml down -v || true

#       - name: Run Odoo tests
#         run: |
#           docker compose -f docker-compose.test.yml up --abort-on-container-exit --exit-code-from odoo
#         continue-on-error: false

#   deploy:
#     name: Deploy to Server
#     needs: test
#     runs-on: self-hosted

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Sync files to server
#         run: |
#           rsync -avz --delete \
#             ./ \
#             $HOME/firstodoo/

#       - name: Rebuild Odoo with retry
#         run: |
#           cd $HOME/firstodoo

#           echo "Stopping old containers..."
#           docker-compose down || true

#           echo "Building new containers..."
#           for i in {1..5}; do
#             docker-compose up -d --build && break
#             echo "Retrying build ($i/5)..."
#             sleep 3
#           done

#       - name: Install new module
#         run: |
#           docker exec odoo18 \
#             odoo -d odoo18 \
#                 -u ALL \
#                 --db_host=db \
#                 --db_port=5432 \
#                 --db_user=odoo18 \
#                 --db_password=odoo18 \
#                 --stop-after-init


#       - name: Check Odoo health
#         run: |
#           curl -f http://localhost:8069 || exit 1



name: CI/CD Odoo

on:
  push:
    branches: ["main"]

jobs:

################################################################################
#                               1.   TESTS
################################################################################
  test:
    name: Test Odoo Modules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Python dependencies for linting
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip
          pip3 install pylint odoolint

      - name: Lint Python
        run: |
          pylint addons/* || true

      - name: Lint XML
        run: |
          odoolint addons/ || true

      - name: Clean old test containers
        run: |
          docker compose -f docker-compose.test.yml down -v || true

      - name: Run Odoo tests
        run: |
          docker compose -f docker-compose.test.yml up \
            --abort-on-container-exit \
            --exit-code-from odoo
        continue-on-error: false


################################################################################
#                               2.   DEPLOY
################################################################################
  deploy:
    name: Deploy to Server
    needs: test
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Sync project to server
        run: |
          rsync -avz --delete \
            ./ \
            $HOME/firstodoo/

      - name: Install Python dependencies (requirements.txt)
        run: |
          cd $HOME/firstodoo
          if [ -f requirements.txt ]; then
            sudo pip3 install -r requirements.txt
          fi

      - name: Stop old containers
        run: |
          cd $HOME/firstodoo
          docker-compose down || true

      - name: Rebuild and start containers (with retry)
        run: |
          cd $HOME/firstodoo
          for i in {1..5}; do
            docker-compose up -d --build && break
            echo "Retrying build ($i/5)..."
            sleep 3
          done

      - name: Detect changed Odoo modules
        id: changed
        run: |
          mods=$(git diff --name-only HEAD~1 HEAD | grep "addons/" | cut -d/ -f2 | uniq | tr "\n" "," | sed 's/,$//')
          if [ -z "$mods" ]; then
            echo "no module changed"
            echo "modules=NONE" >> $GITHUB_OUTPUT
          else
            echo "modules=$mods" >> $GITHUB_OUTPUT
          fi

      - name: Update only changed modules
        if: steps.changed.outputs.modules != 'NONE'
        run: |
          docker exec odoo18 \
            odoo -d odoo18 \
                -u ${{ steps.changed.outputs.modules }} \
                --db_host=db \
                --db_port=5432 \
                --db_user=odoo18 \
                --db_password=odoo18 \
                --stop-after-init

      - name: Rollback on failure
        if: failure()
        run: |
          echo "DEPLOY FAILED — ROLLBACK IN PROGRESS"
          cd $HOME/firstodoo
          git reset --hard HEAD~1
          docker-compose down || true
          docker-compose up -d --build
          exit 1

      - name: Deep healthcheck (robust)
        run: |
          set -euo pipefail

          echo "1) Vérifier que le container odoo18 est en cours d'exécution..."
          if ! docker ps --format '{{.Names}}' | grep -q '^odoo18$'; then
            echo "ERROR: le container odoo18 n'est pas démarré."
            docker ps -a --format "table {{.Names}}\t{{.Status}}"
            docker logs odoo18 || true
            exit 1
          fi

          echo "2) Attente du port HTTP (8069) avec retries (120s max)..."
          max_wait=120
          waited=0
          interval=3
          until curl -sSf http://localhost:8069/ || {
            waited=$((waited+interval))
            if [ "$waited" -ge "$max_wait" ]; then
              echo "Échec: service HTTP non disponible après ${max_wait}s"
              break
            fi
            echo "Attente ${waited}s..."
            sleep $interval
            false
          }; do :; done

          # Si curl n'a jamais réussi, afficher logs et sortir en erreur
          if ! curl -sSf http://localhost:8069/ >/dev/null 2>&1; then
            echo "=== Logs Odoo (dernier 500 lines) ==="
            docker logs --tail 500 odoo18 || true
            echo "Vérifie : port exposé, erreur de démarrage, dépendances manquantes."
            exit 1
          fi

          echo "3) Vérifier l'absence d'erreurs critiques dans les logs (dernier 500 lines)..."
          if docker logs --tail 500 odoo18 2>&1 | grep -iE "traceback|error|critical" >/dev/null; then
            echo "WARN/ERROR trouvé dans les logs. Affichage des lignes pertinentes :"
            docker logs --tail 500 odoo18 2>&1 | grep -iE "traceback|error|critical" || true
            # si tu veux faire échouer le job sur ces erreurs, décommente la ligne suivante
            # exit 1
          else
            echo "Pas d'erreurs critiques détectées dans les derniers logs."
          fi

          echo "4) Check final : requête JSON d'index Odoo (pour vérifier réponse HTTP correcte)..."
          if ! curl -sSf http://localhost:8069/web/database/selector >/dev/null 2>&1; then
            echo "La route /web/database/selector n'a pas répondu comme attendu."
            docker logs --tail 500 odoo18 || true
            exit 1
          fi

          echo "Odoo deployment OK"

